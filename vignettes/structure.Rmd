---
title: "Analyse text structure"
author: "Toshikazu, Matsumura"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{moranajp}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
options(encoding="UTF-8")
library(tidyverse)
library(moranajp)
library(grid)
```

```{r}

width <- function(x, unit = "mm"){
  grid::stringWidth(x) %>%
  grid::convertWidth(unit = unit)
}
one_jp_width <- function(unit = "mm"){
  grid::stringWidth("　") %>%
  grid::convertWidth(unit = unit)
}
data(review_mecab)
cols <- c("text_id", "\\u8868\\u5c64\\u5f62", "\\u54c1\\u8a5e", 
          "\\u54c1\\u8a5e\\u7d30\\u5206\\u985e1", "\\u539f\\u5f62") %>%
        stringi::stri_unescape_unicode()
test_data <- 
  review_mecab %>%
  dplyr::mutate_all(stringi::stri_unescape_unicode) %>%
  magrittr::set_colnames(stringi::stri_unescape_unicode(colnames(.))) %>%
  dplyr::mutate(`:=`(text_id, as.numeric(text_id))) %>%
  dplyr::filter(text_id < 5) %>%
  dplyr::select(tidyselect::all_of(cols)) %>%
  delete_parenthesis() %>%
  clean_mecab_local()

surface_form  <- stringi::stri_unescape_unicode("\u8868\u5c64\u5f62")
original_form <- stringi::stri_unescape_unicode("\u539f\u5f62")
  # text <- 
  #   test_data %>%
  #   dplyr::mutate(`:=`(w, 
  #     stringi::stri_width( .data[[surface_form]]) )) %>%
  #   #   dplyr::mutate(`:=`(w, width(.data[[surface_form]]))) %>%
  #   dplyr::mutate(`:=`(x, 
  #   #     purrr::accumulate(w, `+`, .init = 0) %>% head(-1)
  #     (purrr::accumulate(w, `+`, .init = 0) * one_jp_width() * 0.25)  %>%
  #      utils::head(-1)
  #     ))
  #   #   dplyr::mutate(`:=`(x, x / max(x))) %>%
  # grid::grid.newpage()
  # vp <- viewport(width = max(text$x))
  # grid::grid.text(text$表層形, text$x, just = c("left", "centre"), vp = vp)
text <- 
  test_data %>%
  dplyr::mutate(`:=`(w, 
    stringi::stri_width( .data[[surface_form]]) )) %>%
  dplyr::mutate(`:=`(x, 
    purrr::accumulate(w, `+`) * one_jp_width() * 0.28
    ))


grid::grid.newpage()
vp <- viewport(width = max(text$x))
grid::grid.text(text$表層形, text$x, just = c("right", "centre"), vp = vp)

}
```
